{% csrf_token %}
{% load static %}

<html>
<head>
    <title>Главная</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width", initital-scale=1.0>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>

    <style type="text/css">
      :root {

        --main-rgb: 173, 216, 230;
        --nav-rgb: 0, 98, 139;
        --button-rgb: 255, 255, 255;
        --button-text-rgb: 0, 0, 0;
        color-scheme: light;
      }

      *{
        transition-duration: 0.5s;
       }

      body {
        background-color: rgba(var(--main-rgb));
        margin: 0;
      }

      button.btn {
        background-color: rgba(var(--button-rgb));
        font-size: 16px;
        color: rgba(var(--button-text-rgb));
        border-color: rgba(var(--button-rgb));
      }

      th {
        cursor: pointer;
      }

      th:hover {
        background-color: ghostwhite;
      }

      a {
        color: rgba(var(--button-text-rgb));
      }

      .table-bordered > tbody > tr:nth-child(n+1) > td, .table-bordered > thead > tr:nth-child(n+1) > th {
        background-color: rgba(var(--button-rgb));
        color: rgba(var(--button-text-rgb));

     }

      /* Dark theme */

      .dark {

        --main-rgb: 25, 69, 83;
        --nav-rgb: 7, 19, 23;
        --button-rgb: 71, 106, 117;
        --button-text-rgb: 255, 255, 255;
        color-scheme: dark;
      }

    </style>
</head>

<body>
    {% include 'nav.html' %}

    <div id='upper'>
      <button class="btn btn-light" id='menu' onclick=cleartable() >Clear</button>
      <button class="btn btn-light" id='menu' onclick=insertid() >My ID</button>
      <button class="btn btn-light" id="themeToggle">Dark</button>
      <input type="email" class="steamid" id="steamid" onchange=sender() placeholder="Enter Steam id">
    </div>

    <table id="table" class="table table-bordered table-hover">
        <thead>
            <tr>
              <th data-field="name" onclick=sortTable(0)>Game
              <svg id="sort-icon0" display=none xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-sort-alpha-down" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M10.082 5.629 9.664 7H8.598l1.789-5.332h1.234L13.402 7h-1.12l-.419-1.371h-1.781zm1.57-.785L11 2.687h-.047l-.652 2.157h1.351z"/>
                <path d="M12.96 14H9.028v-.691l2.579-3.72v-.054H9.098v-.867h3.785v.691l-2.567 3.72v.054h2.645V14zM4.5 2.5a.5.5 0 0 0-1 0v9.793l-1.146-1.147a.5.5 0 0 0-.708.708l2 1.999.007.007a.497.497 0 0 0 .7-.006l2-2a.5.5 0 0 0-.707-.708L4.5 12.293V2.5z"/>
              </svg>
              <svg id="sort-icon-sorted0" display=none xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-sort-alpha-up-alt" viewBox="0 0 16 16">
                <path d="M12.96 7H9.028v-.691l2.579-3.72v-.054H9.098v-.867h3.785v.691l-2.567 3.72v.054h2.645V7z"/>
                <path fill-rule="evenodd" d="M10.082 12.629 9.664 14H8.598l1.789-5.332h1.234L13.402 14h-1.12l-.419-1.371h-1.781zm1.57-.785L11 9.688h-.047l-.652 2.156h1.351z"/>
                <path d="M4.5 13.5a.5.5 0 0 1-1 0V3.707L2.354 4.854a.5.5 0 1 1-.708-.708l2-1.999.007-.007a.498.498 0 0 1 .7.006l2 2a.5.5 0 1 1-.707.708L4.5 3.707V13.5z"/>
              </svg>
            </th>

              <th data-field="price" onclick=sortTable(1)>Steam price
              <svg id="sort-icon-sorted1" display=none xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-sort-numeric-down-alt" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M11.36 7.098c-1.137 0-1.708-.657-1.762-1.278h1.004c.058.223.343.45.773.45.824 0 1.164-.829 1.133-1.856h-.059c-.148.39-.57.742-1.261.742-.91 0-1.72-.613-1.72-1.758 0-1.148.848-1.836 1.973-1.836 1.09 0 2.063.637 2.063 2.688 0 1.867-.723 2.848-2.145 2.848zm.062-2.735c.504 0 .933-.336.933-.972 0-.633-.398-1.008-.94-1.008-.52 0-.927.375-.927 1 0 .64.418.98.934.98z"/>
                <path d="M12.438 8.668V14H11.39V9.684h-.051l-1.211.859v-.969l1.262-.906h1.046zM4.5 2.5a.5.5 0 0 0-1 0v9.793l-1.146-1.147a.5.5 0 0 0-.708.708l2 1.999.007.007a.497.497 0 0 0 .7-.006l2-2a.5.5 0 0 0-.707-.708L4.5 12.293V2.5z"/>
              </svg>
              <svg id="sort-icon1" display=none xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-sort-numeric-up" viewBox="0 0 16 16">
                <path d="M12.438 1.668V7H11.39V2.684h-.051l-1.211.859v-.969l1.262-.906h1.046z"/>
                <path fill-rule="evenodd" d="M11.36 14.098c-1.137 0-1.708-.657-1.762-1.278h1.004c.058.223.343.45.773.45.824 0 1.164-.829 1.133-1.856h-.059c-.148.39-.57.742-1.261.742-.91 0-1.72-.613-1.72-1.758 0-1.148.848-1.835 1.973-1.835 1.09 0 2.063.636 2.063 2.687 0 1.867-.723 2.848-2.145 2.848zm.062-2.735c.504 0 .933-.336.933-.972 0-.633-.398-1.008-.94-1.008-.52 0-.927.375-.927 1 0 .64.418.98.934.98z"/>
                <path d="M4.5 13.5a.5.5 0 0 1-1 0V3.707L2.354 4.854a.5.5 0 1 1-.708-.708l2-1.999.007-.007a.498.498 0 0 1 .7.006l2 2a.5.5 0 1 1-.707.708L4.5 3.707V13.5z"/>
              </svg>
            </th>

              <th data-field="rubprice" onclick=sortTable(2)>Shop price
              <svg id="sort-icon-sorted2" display=none xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-sort-numeric-down-alt" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M11.36 7.098c-1.137 0-1.708-.657-1.762-1.278h1.004c.058.223.343.45.773.45.824 0 1.164-.829 1.133-1.856h-.059c-.148.39-.57.742-1.261.742-.91 0-1.72-.613-1.72-1.758 0-1.148.848-1.836 1.973-1.836 1.09 0 2.063.637 2.063 2.688 0 1.867-.723 2.848-2.145 2.848zm.062-2.735c.504 0 .933-.336.933-.972 0-.633-.398-1.008-.94-1.008-.52 0-.927.375-.927 1 0 .64.418.98.934.98z"/>
                <path d="M12.438 8.668V14H11.39V9.684h-.051l-1.211.859v-.969l1.262-.906h1.046zM4.5 2.5a.5.5 0 0 0-1 0v9.793l-1.146-1.147a.5.5 0 0 0-.708.708l2 1.999.007.007a.497.497 0 0 0 .7-.006l2-2a.5.5 0 0 0-.707-.708L4.5 12.293V2.5z"/>
              </svg>
              <svg id="sort-icon2" display=none xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-sort-numeric-up" viewBox="0 0 16 16">
                <path d="M12.438 1.668V7H11.39V2.684h-.051l-1.211.859v-.969l1.262-.906h1.046z"/>
                <path fill-rule="evenodd" d="M11.36 14.098c-1.137 0-1.708-.657-1.762-1.278h1.004c.058.223.343.45.773.45.824 0 1.164-.829 1.133-1.856h-.059c-.148.39-.57.742-1.261.742-.91 0-1.72-.613-1.72-1.758 0-1.148.848-1.835 1.973-1.835 1.09 0 2.063.636 2.063 2.687 0 1.867-.723 2.848-2.145 2.848zm.062-2.735c.504 0 .933-.336.933-.972 0-.633-.398-1.008-.94-1.008-.52 0-.927.375-.927 1 0 .64.418.98.934.98z"/>
                <path d="M4.5 13.5a.5.5 0 0 1-1 0V3.707L2.354 4.854a.5.5 0 1 1-.708-.708l2-1.999.007-.007a.498.498 0 0 1 .7.006l2 2a.5.5 0 1 1-.707.708L4.5 3.707V13.5z"/>
              </svg>
            </th>

              <th data-field="shopsearchlink" onclick=sortTable(3)>Search link
              <svg id="sort-icon3" display=none xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-sort-alpha-down" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M10.082 5.629 9.664 7H8.598l1.789-5.332h1.234L13.402 7h-1.12l-.419-1.371h-1.781zm1.57-.785L11 2.687h-.047l-.652 2.157h1.351z"/>
                <path d="M12.96 14H9.028v-.691l2.579-3.72v-.054H9.098v-.867h3.785v.691l-2.567 3.72v.054h2.645V14zM4.5 2.5a.5.5 0 0 0-1 0v9.793l-1.146-1.147a.5.5 0 0 0-.708.708l2 1.999.007.007a.497.497 0 0 0 .7-.006l2-2a.5.5 0 0 0-.707-.708L4.5 12.293V2.5z"/>
              </svg>
              <svg id="sort-icon-sorted3" display=none xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-sort-alpha-up-alt" viewBox="0 0 16 16">
                <path d="M12.96 7H9.028v-.691l2.579-3.72v-.054H9.098v-.867h3.785v.691l-2.567 3.72v.054h2.645V7z"/>
                <path fill-rule="evenodd" d="M10.082 12.629 9.664 14H8.598l1.789-5.332h1.234L13.402 14h-1.12l-.419-1.371h-1.781zm1.57-.785L11 9.688h-.047l-.652 2.156h1.351z"/>
                <path d="M4.5 13.5a.5.5 0 0 1-1 0V3.707L2.354 4.854a.5.5 0 1 1-.708-.708l2-1.999.007-.007a.498.498 0 0 1 .7.006l2 2a.5.5 0 1 1-.707.708L4.5 3.707V13.5z"/>
              </svg>
            </th>
            </tr>
        </thead>
        <tbody id="tablebody">
          <tr class='tableelement'></tr>
        </tbody>
    </table>

    <input type="hidden" class='column-flag' id="column0">
    <input type="hidden" class='column-flag' id="column1">
    <input type="hidden" class='column-flag' id="column2">
    <input type="hidden" class='column-flag' id="column3">

    <!--Insertid-->
    <script>
        function insertid () {
            cleartable();
            let field = document.getElementById('steamid')
            field.value = '76561198041677591'
            sender();
        };
    </script>

    <!--Sender-->
    <script>
        async function sender() {
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
            let steamid = document.getElementById('steamid').value;
            let data = {'steamid': steamid };

            let loading_div = document.getElementById('upper');
            loading_div.insertAdjacentHTML('beforeEnd', 
                `<div class="spinner spinner-border spinner-border-sm" role="status>
                    <span id="spinner" class="sr-only spinner"></span>
                  </div>`)

            let response = await fetch('/ajax',
             {
              method: 'POST',
              body: JSON.stringify(data),
              headers : {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': csrftoken,
              },
             });

             let response_text = await response.json();

             var arr = []
             for (const [key, value] of Object.entries(response_text)) {
               arr.push(value);
             }

             const elements = document.getElementsByClassName('tableelement');
             while(elements.length > 0){
                 elements[0].parentNode.removeChild(elements[0]);
             }

             let div = document.getElementById('tablebody');
             for (const game of Object.entries(arr[0])) {
                div.insertAdjacentHTML('beforeEnd', 
                `<tr class='tableelement'>
                   <td>${game[1]['name']}</td>
                   <td><a href="${game[1]['steamlink']}">${game[1]['price']}</a></td>
                   <td><a href="${game[1]['shopgamelink']}">${game[1]['rubprice']}</a></td>
                   <td><a href="${game[1]['shopsearchlink']}">${game[1]['shopsearchlink']}</a></td>
                </tr>`)
            }

            const spinners = document.getElementsByClassName('spinner');
             while(spinners.length > 0){
                spinners[0].parentNode.removeChild(spinners[0]);
             }

        }
    </script>

    <!--Clear table-->
    <script>
        function cleartable(){
            // Clear the table
            const toclear = document.getElementsByClassName('tableelement');
            while(toclear.length > 0){
                toclear[0].parentNode.removeChild(toclear[0]);
            }
            // Clear steam id field
            let field = document.getElementById('steamid')
            field.value = ''
            // Clear hidden flag elements for table reverse sorting
            var hidden_elements = document.getElementsByClassName('column-flag')
            for (var i=0; i < hidden_elements.length; i++) {
                hidden_elements[i].value = '';
            }
            // Clear sorting icons
            var hidden_elements = document.getElementsByClassName('bi')
            for (var i=0; i < hidden_elements.length; i++) {
                hidden_elements[i].style.display = 'none';
            }

            const spinners = document.getElementsByClassName('spinner');
             while(spinners.length > 0){
                spinners[0].parentNode.removeChild(spinners[0]);
             }
        };
    </script>
    
    <!--Sort table-->
    <script>
        function sortTable(number) {
            var table, rows, switching, i, x, y, shouldSwitch;
            table = document.getElementById("table");
            switching = true;

            var re = RegExp('>(.*?)<')
            let present_column = document.getElementById(`column${number}`)
            let present_column_val = present_column.value
            /* Make a loop that will continue until
            no switching has been done: */
            while (switching) {
              // Start by saying: no switching is done:
              switching = false;
              rows = table.rows;
              /* Loop through all table rows (except the
              first, which contains table headers): */
              for (i = 1; i < (rows.length - 1); i++) {
                // Start by saying there should be no switching:
                shouldSwitch = false;
                /* Get the two elements you want to compare,
                one from current row and one from the next: */
                x = rows[i].getElementsByTagName("TD")[number];
                y = rows[i + 1].getElementsByTagName("TD")[number];
                
                if (number == 1 && present_column.value != 'sorted') {
                    // Check if the two rows should switch place:
                    if (parseFloat(re.exec(x.innerHTML.toLowerCase())[1]) < parseFloat(re.exec(y.innerHTML.toLowerCase())[1])) {
                      // If so, mark as a switch and break the loop:
                      shouldSwitch = true;
                      break;
                    }
                }
                else if (number == 0 && present_column.value != 'sorted') {
                    if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                        // If so, mark as a switch and break the loop:
                        shouldSwitch = true;
                        break;
                    }
                }
                else if (present_column.value != 'sorted') {
                    if (re.exec(x.innerHTML.toLowerCase())[1] < re.exec(y.innerHTML.toLowerCase())[1]) {
                        // If so, mark as a switch and break the loop:
                        shouldSwitch = true;
                        break;
                    }
                }
                else if (number == 1 && present_column.value == 'sorted') {
                    // Check if the two rows should switch place:
                    if (parseFloat(re.exec(x.innerHTML.toLowerCase())[1]) > parseFloat(re.exec(y.innerHTML.toLowerCase())[1])) {
                      // If so, mark as a switch and break the loop:
                      shouldSwitch = true;
                      break;
                    }
                }
                else if (number == 0 && present_column.value == 'sorted') {
                    if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                        // If so, mark as a switch and break the loop:
                        shouldSwitch = true;
                        break;
                    }
                }
                else if (present_column.value == 'sorted') {
                    if (re.exec(x.innerHTML.toLowerCase())[1] > re.exec(y.innerHTML.toLowerCase())[1]) {
                        // If so, mark as a switch and break the loop:
                        shouldSwitch = true;
                        break;
                    }
                }
              }
              if (shouldSwitch) {
                /* If a switch has been marked, make the switch
                and mark that a switch has been done: */
                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                switching = true;
              }
            }

            // Clear hidden flag elements for table reverse sorting
            var hidden_elements = document.getElementsByClassName('column-flag')
            for (var i=0; i < hidden_elements.length; i++) {
                hidden_elements[i].value = '';
            }

            // Clear sorting icons
            var hidden_elements = document.getElementsByClassName('bi')
            for (var i=0; i < hidden_elements.length; i++) {
                hidden_elements[i].style.display = 'none';
            }

            // Change current column flag and icon
            if (present_column_val == 'sorted') {

                document.getElementById(`sort-icon-sorted${number}`).style.display = 'none'
                document.getElementById(`sort-icon${number}`).style.display = 'inline-block'
                present_column.value = ''

            }
            else if (present_column_val != 'sorted') {
                document.getElementById(`sort-icon-sorted${number}`).style.display = 'inline-block'
                document.getElementById(`sort-icon${number}`).style.display = 'none'
                present_column.value = 'sorted'
            }

        }
    </script>

    <!--Theme change-->
    <script>
        let root = document.querySelector(":root");
        let button = document.querySelector("#themeToggle");
        
        button.addEventListener('click', () => {
          event.preventDefault();
          root.classList.toggle('dark');
          if (themeToggle.textContent == 'Dark') {
            themeToggle.textContent = 'Light';
          } else {
            themeToggle.textContent = 'Dark';
          }
        })
    </script>

</body>
</html>
